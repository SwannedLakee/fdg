<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.5.3.1.min.css"/>
    <link href="/assets/css/styles.css" rel="stylesheet" />
    <link href="/assets/css/extrastyles.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="/assets/img/favico-noglass.png" />
<script type="text/javascript" src="/assets/js/bootstrap.bundle.5.3.1.min.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Построчные Переводы</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}
  .custom-textarea {
    resize: both; /* Позволяет растягивать в любом направлении */
    overflow: auto; /* Добавляет полосы прокрутки при необходимости */
    min-height: 100px; /* Минимальная высота текстового поля */
    max-height: 300px; /* Максимальная высота текстового поля */
  }

.table-container {
  overflow-y: auto; /* Включает вертикальную прокрутку */
  max-height: 300px; /* Максимальная высота контейнера */
}

table {
  width: 100%; /* Занимает всю доступную ширину */
  border-collapse: collapse; /* Объединяет границы ячеек */
}

th, td {
  border: 1px solid black; /* Границы ячеек */
  padding: 8px; /* Внутренний отступ ячеек */
}
label {
  font-weight: bold;
  margin-right: 10px;
}

input[type="text"],
textarea {
  width: 100%;
  margin-bottom: 10px;
}

button {
  padding: 10px 20px;
  background-color: #007bff;
  color: #fff;
  border: none;
  cursor: pointer;
}

button:hover {
  background-color: #0056b3;
}

table {
  width: 100%;
  border-collapse: collapse;
}

table th,
table td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}
</style>
</head>
<body>
        <div class="mt-3">
        <div class="align-items-center align-items-center toggle-switch input-group-append">
            <div id="" class="input-group">
                <a href="/ru/read.php" title="Sutta and Vinaya reading" rel="noreferrer" class="me-1">
                    <svg fill="#979797" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="26px" viewBox="0 0 547.596 547.596" xml:space="preserve" stroke="#979797"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="3.285576"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M540.76,254.788L294.506,38.216c-11.475-10.098-30.064-10.098-41.386,0L6.943,254.788 c-11.475,10.098-8.415,18.284,6.885,18.284h75.964v221.773c0,12.087,9.945,22.108,22.108,22.108h92.947V371.067 c0-12.087,9.945-22.108,22.109-22.108h93.865c12.239,0,22.108,9.792,22.108,22.108v145.886h92.947 c12.24,0,22.108-9.945,22.108-22.108v-221.85h75.965C549.021,272.995,552.081,264.886,540.76,254.788z"></path> </g> </g></svg>
                </a>

                <a href="/ru" title="Sutta and Vinaya search" rel="noreferrer" class="me-1">
                    <img width="24px" alt="find.dhamma.gift icon" src="/assets/img/gray-white.png">
                </a>

                <div class="ms-1 form-check form-switch">
                    <input type="checkbox" class="form-check-input" id="darkSwitch">
                </div>
            </div>
        </div>
    </div>

<div class="input-group mt-2">
<div >
      <label for="indexInput">Номер Текста:</label>
    <input type="search" class="form-control" id="indexInput" placeholder="Номер текста (sn23.1, an3.70 и т.п.">
</div>

<div class="input-group-append ms-1">
    <label for="languageSelect">Язык:</label>
    <select class="form-select" id="languageSelect">
      <option value="pli">Пали</option>
      <option value="en">Английский</option>
    </select>
  </div>
  
  
<div class="input-group-append ms-1">
    <label>Пред / След</label>
    <div class=" ms-1">
        <button class="input-group-append btn btn-primary" onclick="loadPrev()">&lt;</button>
        <button class="input-group-append btn btn-primary" onclick="loadNext()">&gt;</button>
    </div>
</div>
  
   
  </div>
  

<div>
  
  <label class="mt-2" for="translationInput">Текст перевода:</label>
  <textarea id="translationInput" placeholder="1. Введите номер текста в 'Номер Текста'
2. Вставьте русский перевод сюда
3. Нажмите 'Обновить'

Инструмент добавит заголовок и переносы строк.

Можно будет поправить переноcы вручную. 

Если перенос строки где-то не нужен, то нужно объеденить предложения в переводе." class="form-control custom-textarea" rows="15"></textarea>
</div>


<div class="form-check input-group-append ">
  <input class="form-check-input" type="checkbox" id="lineBreakCheckbox">
  <label class="form-check-label" for="lineBreakCheckbox">
    Автопереносы
  </label>
</div>
  <button class="btn btn-primary mt-1 input-group-append " title="Обновить перевод или удалить JSON метаданные" onclick="loadText()">Обновить</button>
  <button class="btn btn-primary mt-1" title="Открыть текст на find.dhamma.gift" id="linkButton">Текст на Fdg</button>
  <button class="btn btn-primary mt-1" title="Сохранить JSON" onclick="downloadJson()">Сохранить</button>
  <button id="processButton" title="Загрузить JSON" class="btn btn-secondary mt-1">Загрузить</button>
  <button class="btn btn-secondary mt-1"  title="Очистить окно ввода текста" onclick="clearInputs()">Очистить Текст</button>
   <a href="https://youtu.be/G6QcaHTa990?si=Ub7KGLLH_pfc1P9Y" title="Видео Инструкция" class="btn btn-primary mt-1" target="_blank">?</a>
   <a href="/assets/readylinebyline.html" title="Обновить Список Готовых" class="btn btn-primary mt-1" target="_blank">
   
   	<svg fill="#fff" height="15px" width="15px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 487.3 487.3" xml:space="preserve">
<g>
	<g>
		<path d="M487.2,69.7c0,12.9-10.5,23.4-23.4,23.4h-322c-12.9,0-23.4-10.5-23.4-23.4s10.5-23.4,23.4-23.4h322.1
			C476.8,46.4,487.2,56.8,487.2,69.7z M463.9,162.3H141.8c-12.9,0-23.4,10.5-23.4,23.4s10.5,23.4,23.4,23.4h322.1
			c12.9,0,23.4-10.5,23.4-23.4C487.2,172.8,476.8,162.3,463.9,162.3z M463.9,278.3H141.8c-12.9,0-23.4,10.5-23.4,23.4
			s10.5,23.4,23.4,23.4h322.1c12.9,0,23.4-10.5,23.4-23.4C487.2,288.8,476.8,278.3,463.9,278.3z M463.9,394.3H141.8
			c-12.9,0-23.4,10.5-23.4,23.4s10.5,23.4,23.4,23.4h322.1c12.9,0,23.4-10.5,23.4-23.4C487.2,404.8,476.8,394.3,463.9,394.3z
			 M38.9,30.8C17.4,30.8,0,48.2,0,69.7s17.4,39,38.9,39s38.9-17.5,38.9-39S60.4,30.8,38.9,30.8z M38.9,146.8
			C17.4,146.8,0,164.2,0,185.7s17.4,38.9,38.9,38.9s38.9-17.4,38.9-38.9S60.4,146.8,38.9,146.8z M38.9,262.8
			C17.4,262.8,0,280.2,0,301.7s17.4,38.9,38.9,38.9s38.9-17.4,38.9-38.9S60.4,262.8,38.9,262.8z M38.9,378.7
			C17.4,378.7,0,396.1,0,417.6s17.4,38.9,38.9,38.9s38.9-17.4,38.9-38.9C77.8,396.2,60.4,378.7,38.9,378.7z"/>
	</g>
</g>
</svg>	
   
   </a>   




 
  <div id="translationJsonOutput"></div>
<div class="table-container mt-2 mb-3">

  <table class=" table-hover">
    <thead>
      <tr>
        <th>Текст</th>
        <th>Индексы</th>
        <th>Перевод</th>
      </tr>
    </thead>
    <tbody id="outputTableBody"></tbody>
  </table>
  </div>
<div  class="my-3">
      
    
<input type="file" id="fileInput" style="display:none" accept=".json" />
<script>
  document.getElementById('processButton').addEventListener('click', function() {
    // Получаем значение из textarea
    const inputText = document.getElementById('translationInput').value;

    if (inputText.trim() === '') {
      // Если textarea пустая, открываем диалог для загрузки файла
      document.getElementById('fileInput').click();
    } else {
      // Если есть текст, продолжаем обработку JSON
      processJson(inputText);
    }
  });

  // Обработчик загрузки файла
  document.getElementById('fileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];

    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileContent = e.target.result;
        processJson(fileContent);
      };
      reader.readAsText(file);
    }
  });

  // Функция обработки JSON (из textarea или файла)
  function processJson(inputText) {
    try {
      // Преобразуем текст в объект JSON
      const jsonObject = JSON.parse(inputText);

      // Извлекаем все значения из JSON объекта
      const values = Object.values(jsonObject);

      // Объединяем значения в одну строку, разделенную переносами строки
      const result = values.join('\n');

      // Устанавливаем результат в textarea
      document.getElementById('translationInput').value = result;
    } catch (error) {
    //  alert('Ошибка при обработке JSON. Убедитесь, что введён корректный JSON.');
    
	// Выводим диалог для загрузки файла
  const proceed = confirm('Хотите загрузить файл для замены данных?');

  if (proceed) {
    // Если пользователь согласился, открываем диалог загрузки файла
    document.getElementById('fileInput').click();
  }
	}
	
  }
  
  
  
</script>


</div>

<script>
function downloadJson() {
  const language = document.getElementById('languageSelect').value;
  const indexValue = document.getElementById('indexInput').value.trim().toLowerCase();
  const translation = document.getElementById('translationInput').value.trim();

  // Split the translation text into lines
  const translationLines = translation.split('\n');

  // Object to hold the JSON data
  const jsonData = {};

  // Extracting only letters from indexValue
  const lettersOnly = indexValue.match(/[a-z]+/)[0];

  // Extracting all characters before the dot
  const beforeDot = indexValue.split('.')[0];

  let url;
  if (language === 'pli') {
    url = `/suttacentral.net/sc-data/sc_bilara_data/root/pli/ms/sutta/${lettersOnly}/${beforeDot}/${indexValue}_root-pli-ms.json`;

  } else if (language === 'en') {
    url = `/suttacentral.net/sc-data/sc_bilara_data/translation/en/sujato/sutta/${lettersOnly}/${beforeDot}/${indexValue}_translation-en-sujato.json`;
  }
   //   url = `/suttacentral.net/sc-data/sc_bilara_data/root/pli/ms/sutta/kn/snp/vagga3/snp3.2_root-pli-ms.json`;
console.log(url);
  fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      // Convert data object to array of [key, value] pairs
      const dataArray = Object.entries(data);

      // Iterate through each key in the data object
      dataArray.forEach(([key, value], index) => {
        // Get the corresponding line from the translation text
        const translationLine = translationLines[index] || ''; // Use index from iteration

        // Create key-value pair in JSON object
        jsonData[key] = translationLine;
      });

      // Convert JSON object to string
      const jsonString = JSON.stringify(jsonData, null, 2);

      // Create Blob object with JSON string
      const blob = new Blob([jsonString], { type: 'application/json' });

      // Create download link
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = indexValue + '_translation-ru-sv.json';

      // Append link to the body and click it programmatically
      document.body.appendChild(a);
      a.click();

      // Cleanup
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(error => console.error('Error fetching data:', error.message));
}
</script>

<script>
function loadText() {
  const language = document.getElementById('languageSelect').value;
  const indexValue = document.getElementById('indexInput').value.trim().toLowerCase();
  let translation = document.getElementById('translationInput').value.trim();

let cleanedTranslation = translation;

  // Проверяем, является ли ввод валидным JSON
  try {
    const jsonObject = JSON.parse(translation);
    // Если это JSON, очищаем его с помощью processJson
    processJson(translation);
    return;  // Прекращаем дальнейшую обработку, так как JSON уже очищен
  } catch (error) {
    // Если это не JSON, продолжаем обычную обработку текста
  }



if (document.getElementById('lineBreakCheckbox').checked) {
  cleanedTranslation = translation.replace(/[\.…:?!] /g, match => {
    let index = translation.indexOf(match);
    if (translation.charAt(index + match.length) !== '\n') {
      return `${match}\n`;
    }
    return match;
  });
}
  
cleanedTranslation = cleanedTranslation.replace(/(?<!\n)то точно также/g, '\nточно также');
cleanedTranslation = cleanedTranslation.replace(/(?<!\n)то точно также/g, '\nто точно также');
cleanedTranslation = cleanedTranslation.replace(/^\*\s+/gm, '');

cleanedTranslation = cleanedTranslation.replace(/^.*\[Благословенный сказал\]:.*$/gm, '');

if (document.getElementById('lineBreakCheckbox').checked) {
cleanedTranslation = cleanedTranslation.replace(/^\s*[\r\n]/gm, '');
}



if (indexValue.includes("sn")) {
    if (!cleanedTranslation.startsWith("Связанные Наставления")) {
        const additionalLines = `Связанные Наставления ${indexValue.replace(/[a-z]/g, '')}\nГлава \nСутта \n\n\nНомерТекста.`;
        cleanedTranslation = additionalLines + cleanedTranslation;
    } else if (cleanedTranslation.startsWith("Связанные Наставления")) {
        cleanedTranslation = `Связанные Наставления ${indexValue.replace(/[a-z]/g, '')}${cleanedTranslation.substring(cleanedTranslation.indexOf("\n"))}`;
    }
} else if (indexValue.includes("an")) {
    if (!cleanedTranslation.startsWith("Восходящие Наставления")) {
        const additionalLines = `Восходящие Наставления ${indexValue.replace(/[a-z]/g, '')}\nГлава \nСутта \n\n\nНомерТекста.`;
        cleanedTranslation = additionalLines + cleanedTranslation;
    } else if (cleanedTranslation.startsWith("Восходящие Наставления")) {
        cleanedTranslation = `Восходящие Наставления ${indexValue.replace(/[a-z]/g, '')}${cleanedTranslation.substring(cleanedTranslation.indexOf("\n"))}`;
    }
} 

  document.getElementById('translationInput').value = cleanedTranslation;

  const translationLines = cleanedTranslation.split('\n');
  const lettersOnly = indexValue.match(/[a-z]+/)[0];
  const beforeDot = indexValue.split('.')[0];
  let url;

  if (language === 'pli') {
    url = `/suttacentral.net/sc-data/sc_bilara_data/root/pli/ms/sutta/${lettersOnly}/${beforeDot}/${indexValue}_root-pli-ms.json`;
  } else if (language === 'en') {
    url = `/suttacentral.net/sc-data/sc_bilara_data/translation/en/sujato/sutta/${lettersOnly}/${beforeDot}/${indexValue}_translation-en-sujato.json`;
  }
  //    url = `/suttacentral.net/sc-data/sc_bilara_data/root/pli/ms/sutta/kn/snp/vagga3/snp3.2_root-pli-ms.json`;
console.log(url);
  fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      const tableBody = document.getElementById('outputTableBody');
      tableBody.innerHTML = '';

      const dataArray = Object.entries(data);

      dataArray.forEach(([key, value], index) => {
        const translationLine = translationLines[index] || '';
        const texts = translationLine.split('\n');

        texts.forEach((text, textIndex) => {
          const currentText = texts[textIndex] || '';

          const row = `<tr>
                        <td>${value}</td>
                        <td>${key}</td>
                        <td>${currentText}</td>
                      </tr>`;
          tableBody.innerHTML += row;
        });
      });
    })
    .catch(error => console.error('Error fetching data:', error.message));
}
</script>


<script>

function loadPrev() {
      
	 const texttype = 'sutta';
  const indexValue = document.getElementById('indexInput').value.trim().toLowerCase();

const textPart = indexValue.split('.')[0]; // Разделяем по точке и берем первую часть
const book = indexValue.replace(/[^a-zA-Z]/g, ''); // Убираем все символы кроме букв

	const valueForApi = book + "/" + textPart + "/" + indexValue;
    const url = "/sc/api.php?fromjs=" + texttype + "/" + valueForApi + "&type=B";
    
    // Сохраняем текущее значение поля, чтобы вернуть его в случае ошибки
    const originalValue = indexValue;

    console.log("Prev URL: ", url);
    fetch(url)
        .then(response => response.text()) // Работаем с текстом, а не с JSON
        .then(data => {
            console.log("Prev Data: ", data);
            
            const newIndexValue = extractIndexValue(data);

            // Обновляем поле indexInput полученным значением
            if (newIndexValue) {
                document.getElementById('indexInput').value = newIndexValue;
            }

            // Вызываем loadText() для обновления данных
            loadText();
        })
        .catch(error => {
            console.error('Error fetching prev data:', error);

            // В случае ошибки, возвращаем оригинальное значение поля
            document.getElementById('indexInput').value = originalValue;
        });
}

function loadNext() {
   
	 const texttype = 'sutta';
	  const indexValue = document.getElementById('indexInput').value.trim().toLowerCase();


const textPart = indexValue.split('.')[0]; // Разделяем по точке и берем первую часть
const book = indexValue.replace(/[^a-zA-Z]/g, ''); // Убираем все символы кроме букв

	const valueForApi = book + "/" + textPart + "/" + indexValue;
    const url = "/sc/api.php?fromjs=" + texttype + "/" + valueForApi + "&type=A";
    
    // Сохраняем текущее значение поля, чтобы вернуть его в случае ошибки
    const originalValue = indexValue;

    console.log("Next URL: ", url);
    fetch(url)
        .then(response => response.text()) // Работаем с текстом, а не с JSON
        .then(data => {
            console.log("Next Data: ", data);
            
            const newIndexValue = extractIndexValue(data);

            // Обновляем поле indexInput полученным значением
            if (newIndexValue) {
                document.getElementById('indexInput').value = newIndexValue;
            }

            // Вызываем loadText() для обновления данных
            loadText();
        })
        .catch(error => {
            console.error('Error fetching next data:', error);

            // В случае ошибки, возвращаем оригинальное значение поля
            document.getElementById('indexInput').value = originalValue;
        });
}

// Функция для извлечения нового значения для поля "indexInput" из данных API
function extractIndexValue(data) {
    // Здесь нужно реализовать логику для извлечения номера текста из строки "sn17.2 Baḷisasutta"
    // Например, если это всегда строка перед первым пробелом:
    return data.split(' ')[0]; // Вернёт "sn17.2"
}

</script>



<script>


// Общий обработчик для элементов с id "indexInput" и "languageSelect"
document.addEventListener('keydown', function(event) {
    const target = event.target;
    
    // Проверяем, если фокус находится на поле indexInput или languageSelect
    if ((target.id === 'indexInput' || target.id === 'languageSelect') && event.key === 'Enter') {
        event.preventDefault(); // Отменяем стандартное поведение Enter
        loadText(); // Запускаем функцию обновления текста
    }
});




// Функция для сохранения значений
function saveInputs() {
  localStorage.setItem('indexValue', indexInput.value);
  localStorage.setItem('translationValue', translationInput.value);
  localStorage.setItem('lineBreakCheckboxState', lineBreakCheckbox.checked);
 // Сохраняем состояние чекбокса как булево значение
}

// Функция для загрузки сохраненных значений
function loadInputs() {
  indexInput.value = localStorage.getItem('indexValue') || '';
  translationInput.value = localStorage.getItem('translationValue') || '';
  // Если значение чекбокса в localStorage отсутствует или false, устанавливаем его в true по умолчанию
  lineBreakCheckbox.checked = localStorage.getItem('lineBreakCheckboxState') === 'true';
}

// Вызываем функцию загрузки сохраненных значений при загрузке страницы
loadInputs();
// Сохраняем значения при изменении инпутов
indexInput.addEventListener('input', saveInputs);
translationInput.addEventListener('input', saveInputs);
lineBreakCheckbox.addEventListener('input', saveInputs);
 
function clearInputs() {
  // Показать предупреждение
  if (confirm('Вы действительно хотите очистить перевод?')) {
    // Если пользователь подтвердил, очищаем значения инпутов
    document.getElementById('translationInput').value = '';

    // Очищаем сохраненные значения в localStorage
    localStorage.removeItem('translationValue');
    localStorage.removeItem('lineBreakCheckboxState');
  }
}

</script>
    <script src="/assets/js/dark-mode-switch/dark-mode-switch.js"></script>
  
  
  

<script>
    document.getElementById('linkButton').addEventListener('click', function() {
        var indexValue = document.getElementById('indexInput').value;
        var url = '/ru/sc?q=' + indexValue;
        window.open(url, '_blank');
    });
</script>  
</body>
</html>