<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open in T2S</title>
  
  <link href="/assets/css/bootstrap.5.3.1.min.css" rel="stylesheet" />
  <link href="/assets/css/styles.css" rel="stylesheet" />
  <link href="/assets/css/extrastyles.css" rel="stylesheet" />
  <link href="/assets/css/pages.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/jquery-ui.min.css">
  <link href="/assets/css/paliLookup.css" rel="stylesheet" />

  <style>
    :root {
      --bg-color: #f4f4f9;
      --card-bg: #ffffff;
    }
    [data-theme="dark"] {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
    }
    body {
      background-color: var(--bg-color);
      transition: background-color 0.3s;
    }
    .main-content {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .card {
      width: 100%;
      max-width: 420px;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: none;
    }
    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .btn-mode {
      flex: 1 1 45%;
      padding: 12px;
      text-align: center;
      border-radius: 8px;
      background: #e0e0e0;
      color: #000;
      text-decoration: none;
      font-size: 15px;
    }
    [data-theme="dark"] .btn-mode {
      background: #333;
      color: #eee;
    }
    .btn-mode.active {
      background: #007bff;
      color: #fff;
    }
    .main-btn {
      display: block;
      text-align: center;
      padding: 16px;
    
      color: #fff;
      border-radius: 12px;
      text-decoration: none;
      font-size: 18px;
    }
  </style>
</head>

<body>

<div class="container mt-3">
  <div class="d-flex flex-wrap align-items-center justify-content-between">
    <div class="d-flex align-items-center order-1 mb-2 mb-sm-0">
      <a id="readLink" href="/read.php" title="Sutta and Vinaya reading" rel="noreferrer" class="me-1">
        <svg fill="#979797" xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 0 547.596 547.596">
          <path d="M540.76,254.788L294.506,38.216c-11.475-10.098-30.064-10.098-41.386,0L6.943,254.788 c-11.475,10.098-8.415,18.284,6.885,18.284h75.964v221.773c0,12.087,9.945,22.108,22.108,22.108h92.947V371.067 c0-12.087,9.945-22.108,22.109-22.108h93.865c12.239,0,22.108,9.792,22.108,22.108v145.886h92.947 c12.24,0,22.108-9.945,22.108-22.108v-221.85h75.965C549.021,272.995,552.081,264.886,540.76,254.788z"></path>
        </svg>
      </a>

<script>
  
      function handleReadLink(event) {
        const btn = event.currentTarget; 
        if (!btn) return;

        // Строим URL на основе текущего href кнопки
        const targetUrl = new URL(btn.getAttribute('href'), window.location.origin);
        
        // Получаем ВСЕ текущие параметры из адресной строки браузера
        const currentParams = new URLSearchParams(window.location.search);
        
        // Переносим параметры в целевую ссылку
        currentParams.forEach((value, key) => {
            targetUrl.searchParams.set(key, value);
        });
        
        // Добавляем текущий якорь (хеш)
        targetUrl.hash = window.location.hash;
        
        // Обновляем ссылку
        btn.href = targetUrl.toString();
    }

    // Инициализация
    const readLinkBtn = document.getElementById('readLink');
    
    // Проверка: код сработает только если на странице есть кнопка с id="readLink"
    if (readLinkBtn) {
        // 1. Вешаем обработчик клика (чтобы обновилось прямо перед переходом)
        readLinkBtn.addEventListener('click', handleReadLink);
        
        // 2. Вызываем один раз сразу при загрузке
        // Это нужно, чтобы при наведении мыши (hover) ссылка уже была правильной
        handleReadLink({ currentTarget: readLinkBtn });
    }
</script>

      <a id="homeLink" href="/" title="Sutta and Vinaya search" rel="noreferrer" class="me-0">
        <img width="24px" alt="dhamma.gift icon" class="me-1" src="/assets/img/gray-white.png">
      </a>

      <div id="chapter-button" class="mode-switch me-1">
        <a href="/r.php" title="Read Chapters"><img width="28px" alt="Read by Chapters" src="/assets/svg/book.svg"></a>
      </div>

      <a title="Dictionary" class="toggle-dict-btn text-decoration-none text-black me-1">
        <img src="/assets/svg/comment.svg" style="width: 24px;">
      </a>

      <div class="ms-1 form-check form-switch">
        <input type="checkbox" class="form-check-input" id="darkSwitch">
      </div>

      <a href="/assets/common/ttsHelp.html" class="text-decoration-none text-muted ms-1">
        <img width="15px" alt="Help" src="/assets/svg/question.svg">
      </a>
    </div>

    <form id="slugForm" class="d-flex align-items-center flex-nowrap order-3 order-sm-2 mx-auto flex-grow-0" onsubmit="return goToSlug();" style="min-width: 140px; max-width: 250px;">
    <label class="sr-only dropup rounded-pill mb-2" for="paliauto"></label>
    
      <input type="search" class="form-control form-control-sm rounded-pill me-1 flex-grow-1" id="paliauto" name="q" autofocus placeholder="e.g. an3.76">

  
      <button type="submit" id="searchbtn" class="btn btn-sm btn-outline-secondary rounded-circle p-1 flex-shrink-0">Go</button>
    </form>
  </div>
</div>

<div class="main-content">
  <div class="card">
    <div class="buttons">
      <a class="btn-mode" data-mode="pali">Pāḷi</a>
      <a class="btn-mode" data-mode="ru">Русский</a>

      <a class="btn-mode" data-mode="bs">English · Sujato</a>
      <a class="btn-mode" data-mode="bb">English · Bodhi</a>
    </div>
    <a id="open" class="main-btn btn-primary">Open in T2S</a>
  </div>
</div>

<script src="/assets/js/jquery-3.7.0.min.js"></script>
<script src="/assets/js/dark-mode-switch/dark-mode-switch.js"></script>

<script>
const params = new URLSearchParams(location.search);
const q = params.get('q');
const mode = params.get('mode');

// Заполняем поле поиска текущим запросом, если он есть
if (q) document.getElementById('paliauto').value = q;

// 2. Функция для создания intent-ссылки T2S
function buildIntent(m) {
  const intentParams = new URLSearchParams(window.location.search);
  let path = '/ru/tts.php'; 

  if (m === 'pali') { 
      path = '/tts.php'; 
      intentParams.set('type', 'pali');
      intentParams.delete('translator'); 
  }
  else if (m === 'bs') { 
      path = '/tts.php'; 
      intentParams.set('type', 'trn');
      intentParams.set('translator', 'bs'); 
  }
  else if (m === 'bb') { 
      path = '/tts.php'; 
      intentParams.set('type', 'trn');
      intentParams.set('translator', 'bb'); 
  }
  else { 
      path = '/ru/tts.php'; 
      intentParams.set('type', 'trn');
      intentParams.delete('translator');
  }

  const host = window.location.host;
  const scheme = window.location.protocol.replace(':', '');
  const queryStr = intentParams.toString();
  const hash = window.location.hash; 

  return `intent://${host}${path}?${queryStr}${hash}#Intent;scheme=${scheme};package=hesoft.T2S;end`;
}

function goToSlug() {
    const newSlug = document.getElementById('paliauto').value.trim();
    if (newSlug) {
        const url = new URL(window.location.href);
        url.searchParams.set('q', newSlug);
        window.location.href = url.toString();
    }
    return false;
}

const openBtn = document.getElementById('open');
openBtn.href = buildIntent(mode);

// 3. Обработка кнопок переключения режимов
document.querySelectorAll('.btn-mode').forEach(btn => {
  const targetMode = btn.dataset.mode;
  const urlParams = new URLSearchParams(window.location.search);
  
  urlParams.set('mode', targetMode);
  
  btn.href = '?' + urlParams.toString() + window.location.hash;
  
  if (targetMode === mode) btn.classList.add('active');
});

if (!mode) {
  setTimeout(() => { location.href = buildIntent(null); }, 300);
}
</script>
<script src="/assets/js/jquery-ui.min.js" defer></script>
<script src="/assets/js/autopali.js" defer></script>

 <script src="/assets/js/autopali.js" defer></script>

</body>
</html>
